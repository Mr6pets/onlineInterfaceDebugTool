# 开发环境配置

<cite>
**本文档中引用的文件**  
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml)
- [tsconfig.json](file://tsconfig.json)
- [packages/shared/tsconfig.json](file://packages/shared/tsconfig.json)
- [packages/web-full/vite.config.ts](file://packages/web-full/vite.config.ts)
- [packages/web-lite/vite.config.ts](file://packages/web-lite/vite.config.ts)
- [packages/web-pro/vite.config.ts](file://packages/web-pro/vite.config.ts)
</cite>

## 目录
1. [开发环境搭建指南](#开发环境搭建指南)
2. [PNPM包管理器安装与依赖管理](#pnpm包管理器安装与依赖管理)
3. [多包结构与pnpm-workspace.yaml配置](#多包结构与pnpm-workspaceyaml配置)
4. [TypeScript配置与路径别名](#typescript配置与路径别名)
5. [Vite构建配置详解](#vite构建配置详解)
6. [常见环境问题排查](#常见环境问题排查)
7. [总结](#总结)

## 开发环境搭建指南

本指南旨在帮助开发者快速搭建本地开发环境，确保项目能够顺利运行和调试。通过本指南，您将了解如何安装PNPM、配置多包结构、理解TypeScript和Vite的配置，并解决常见的环境问题。

## PNPM包管理器安装与依赖管理

### 安装PNPM

PNPM是一个高效的Node.js包管理器，支持硬链接和符号链接，能够显著减少磁盘空间占用并加快安装速度。安装PNPM的方法如下：

```bash
# 使用npm安装pnpm
npm install -g pnpm

# 或使用独立脚本安装
curl -fsSL https://get.pnpm.io/install.sh | sh
```

安装完成后，可通过以下命令验证版本：

```bash
pnpm --version
```

### 安装项目依赖

在项目根目录执行以下命令以安装所有依赖：

```bash
pnpm install
```

该命令会根据`pnpm-lock.yaml`文件精确还原依赖版本，确保团队成员之间的依赖一致性。

**Section sources**
- [pnpm-lock.yaml](file://pnpm-lock.yaml#L1-L10)

## 多包结构与pnpm-workspace.yaml配置

### 多包项目结构

本项目采用多包（monorepo）架构，所有子项目均位于`packages/`目录下，包括：
- `shared`：共享工具与类型定义
- `web-lite`：轻量版Web应用
- `web-full`：完整版Web应用
- `web-pro`：专业版Web应用

这种结构有利于代码复用和独立发布。

### pnpm-workspace.yaml解析

该文件定义了PNPM工作区的包扫描范围：

```yaml
packages:
  - 'packages/*'
```

此配置表示PNPM将自动识别`packages/`目录下的所有子目录为工作区包，支持跨包依赖解析和软链接构建。

**Section sources**
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml#L1-L2)

## TypeScript配置与路径别名

### 根目录tsconfig.json配置

根目录的`tsconfig.json`为整个项目提供基础类型配置，并通过`references`字段启用项目引用机制，实现类型检查的模块化。

关键配置项说明：

- `compilerOptions`: 定义编译目标、模块系统、严格模式等
- `include`: 指定需要类型检查的文件路径
- `references`: 声明子项目引用，支持跨项目类型导航

### 路径别名配置

通过`paths`字段定义模块路径别名：

```json
"paths": {
  "@shared/*": ["./packages/shared/*"]
}
```

此配置允许使用`import { utils } from '@shared/utils'`方式导入共享模块，提升代码可读性和可维护性。

### 子项目继承机制

各子项目通过`extends`继承根配置，同时可覆盖特定选项。例如`web-pro`项目：

```json
{
  "extends": "../../tsconfig.json",
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"],
      "@onlineInterfaceDebugTool/shared/*": ["../shared/src/*"]
    }
  }
}
```

`shared`包则独立配置输出目录和声明文件生成：

```json
"outDir": "dist",
"declaration": true
```

**Section sources**
- [tsconfig.json](file://tsconfig.json#L1-L35)
- [packages/shared/tsconfig.json](file://packages/shared/tsconfig.json#L1-L28)

## Vite构建配置详解

### 共同配置结构

所有前端子项目均使用Vite作为构建工具，其`vite.config.ts`具有统一结构：

```ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'

export default defineConfig({
  plugins: [vue()],
  resolve: { /* 路径别名 */ },
  server: { /* 开发服务器 */ },
  build: { /* 构建选项 */ }
})
```

### 环境变量与插件集成

- `plugins`: 集成Vue3支持
- `resolve.alias`: 配置`@`指向`src`目录，`@shared`指向共享包
- `server.port`: 不同版本使用不同端口（3000/3001/3002）
- `build.outDir`: 输出目录统一为`dist`
- `build.sourcemap`: 启用源码映射便于调试

### 开发服务器配置

各子项目配置独立开发端口：
- web-lite: 3000
- web-full: 3001
- web-pro: 3002

`open: true`确保启动时自动打开浏览器。

**Section sources**
- [packages/web-full/vite.config.ts](file://packages/web-full/vite.config.ts#L1-L20)
- [packages/web-lite/vite.config.ts](file://packages/web-lite/vite.config.ts#L1-L20)
- [packages/web-pro/vite.config.ts](file://packages/web-pro/vite.config.ts#L1-L20)

## 常见环境问题排查

### 依赖冲突解决

当出现依赖版本冲突时，可采取以下措施：
1. 执行`pnpm install --force`强制重新安装
2. 使用`pnpm dedupe`优化依赖树
3. 检查`pnpm-lock.yaml`是否存在异常版本锁定

### TypeScript类型解析失败

常见原因及解决方案：
- **找不到模块 '@shared/utils'**：确认`tsconfig.json`中`paths`配置正确，且已执行`pnpm install`
- **类型声明缺失**：确保`shared`包已构建（`pnpm --filter shared build`），生成`dist/index.d.ts`
- **编辑器类型错误**：重启TypeScript服务（VS Code中执行"TypeScript: Restart TS Server"）

### Vite启动失败

- **端口被占用**：修改`vite.config.ts`中的`server.port`
- **别名不生效**：确认`resolve.alias`配置正确，路径使用`resolve(__dirname, '...')`
- **HMR异常**：清除`node_modules/.vite`缓存目录

### 构建脚本说明

项目提供统一构建脚本`scripts/build.js`，可批量构建所有版本并输出至`dist/`目录：

```js
// 构建所有版本
pnpm run build:all
```

**Section sources**
- [scripts/build.js](file://scripts/build.js#L1-L37)

## 总结

通过本指南，开发者可完整搭建项目开发环境。核心要点包括：
- 使用PNPM管理依赖，确保高效与一致性
- 理解多包结构与路径别名机制
- 掌握TypeScript项目引用与Vite构建配置
- 熟悉常见问题的排查方法

新贡献者应按照此流程操作，即可实现从零到可调试的完整环境搭建。