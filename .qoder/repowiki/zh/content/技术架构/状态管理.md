# 状态管理

<cite>
**本文档引用文件**  
- [collection.ts](file://packages/web-full/src/stores/collection.ts)
- [environment.ts](file://packages/web-full/src/stores/environment.ts)
- [workspace.ts](file://packages/web-full/src/stores/workspace.ts)
- [team.ts](file://packages/web-full/src/stores/team.ts)
- [automation.ts](file://packages/web-pro/src/stores/automation.ts)
- [storage.ts](file://packages/shared/utils/storage.ts)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心状态模块设计](#核心状态模块设计)
3. [模块化拆分原则与业务对应关系](#模块化拆分原则与业务对应关系)
4. [异步操作处理模式](#异步操作处理模式)
5. [数据派生与getters使用](#数据派生与getters使用)
6. [状态持久化机制](#状态持久化机制)
7. [状态调用链路示例](#状态调用链路示例)
8. [依赖关系图](#依赖关系图)

## 项目结构

项目采用模块化架构，状态管理集中于各子包的 `stores` 目录中。`web-full` 包含完整的状态模块，`web-pro` 包扩展了高级功能模块，`web-lite` 包提供基础状态支持。

**Section sources**
- [collection.ts](file://packages/web-full/src/stores/collection.ts)
- [environment.ts](file://packages/web-full/src/stores/environment.ts)
- [workspace.ts](file://packages/web-full/src/stores/workspace.ts)
- [team.ts](file://packages/web-full/src/stores/team.ts)
- [automation.ts](file://packages/web-pro/src/stores/automation.ts)

## 核心状态模块设计

### 集合状态模块 (collection)
该模块管理API集合、请求、历史记录和批量测试结果，支持导入导出多种格式。

```mermaid
classDiagram
class ApiCollection {
+id : string
+name : string
+description : string
+folders : CollectionFolder[]
+requests : CollectionRequest[]
+createdAt : Date
+updatedAt : Date
}
class CollectionFolder {
+id : string
+name : string
+description : string
+parentId : string
+requests : CollectionRequest[]
+folders : CollectionFolder[]
}
class CollectionRequest {
+id : string
+name : string
+description : string
+folderId : string
+request : RequestConfig
+examples : Example[]
}
class RequestConfig {
+url : string
+method : HttpMethod
+headers : Record~string, string~
+params : Record~string, string~
+data : any
}
class HistoryRecord {
+id : string
+request : RequestConfig
+response : ResponseData
+timestamp : Date
+success : boolean
+collectionId : string
}
class ResponseData {
+status : number
+statusText : string
+headers : Record~string, string~
+data : any
+duration : number
+size : number
}
ApiCollection --> CollectionFolder : "包含"
ApiCollection --> CollectionRequest : "包含"
CollectionFolder --> CollectionRequest : "包含"
CollectionRequest --> RequestConfig : "引用"
useCollectionStore --> ApiCollection : "管理"
useCollectionStore --> HistoryRecord : "记录"
```

**Diagram sources**
- [collection.ts](file://packages/web-full/src/stores/collection.ts#L15-L80)

### 环境状态模块 (environment)
该模块管理环境变量、环境组、模板和全局变量，支持环境切换和变量冲突检测。

```mermaid
classDiagram
class Environment {
+id : string
+name : string
+description : string
+variables : Record~string, string~
+groupId : string
+isActive : boolean
+createdAt : Date
+updatedAt : Date
}
class EnvironmentGroup {
+id : string
+name : string
+description : string
+color : string
+createdAt : Date
+updatedAt : Date
}
class EnvironmentVariable {
+id : string
+key : string
+value : string
+description : string
+isSecret : boolean
+isEnabled : boolean
}
class EnvironmentTemplate {
+id : string
+name : string
+description : string
+variables : EnvironmentVariable[]
+tags : string[]
+createdAt : Date
+updatedAt : Date
}
useEnvironmentStore --> Environment : "管理"
useEnvironmentStore --> EnvironmentGroup : "管理"
useEnvironmentStore --> EnvironmentTemplate : "管理"
useEnvironmentStore --> EnvironmentVariable : "管理"
Environment --> EnvironmentGroup : "属于"
EnvironmentTemplate --> EnvironmentVariable : "包含"
```

**Diagram sources**
- [environment.ts](file://packages/web-full/src/stores/environment.ts#L15-L80)

### 工作空间状态模块 (workspace)
该模块管理工作空间、团队、权限和活动日志，是企业级功能的核心。

```mermaid
classDiagram
class Workspace {
+id : string
+name : string
+description : string
+collections : ApiCollection[]
+environments : Environment[]
+isPublic : boolean
+ownerId : string
+members : string[]
+settings : WorkspaceSettings
+createdAt : Date
+updatedAt : Date
}
class WorkspaceSettings {
+timeout : number
+followRedirects : boolean
+validateSSL : boolean
+maxRedirects : number
+requestDelay : number
}
class User {
+id : string
+name : string
+email : string
+role : TeamRole
+avatar : string
}
class Team {
+id : string
+name : string
+description : string
+ownerId : string
+settings : TeamSettings
+createdAt : Date
}
class TeamSettings {
+allowInvites : boolean
+defaultRole : 'editor' | 'viewer'
+requireApproval : boolean
+maxMembers : number
}
class TeamMember {
+id : string
+name : string
+email : string
+role : 'admin' | 'editor' | 'viewer'
+status : 'active' | 'inactive' | 'pending'
+permissions : string[]
}
class ActivityLog {
+id : string
+userId : string
+timestamp : Date
+action : string
+resource : string
+resourceId : string
+details : string
}
useWorkspaceStore --> Workspace : "管理"
useWorkspaceStore --> User : "管理"
useWorkspaceStore --> Team : "管理"
useWorkspaceStore --> TeamMember : "管理"
useWorkspaceStore --> ActivityLog : "记录"
Workspace --> WorkspaceSettings : "配置"
Team --> TeamSettings : "配置"
```

**Diagram sources**
- [workspace.ts](file://packages/web-full/src/stores/workspace.ts#L15-L80)

### 团队状态模块 (team)
该模块管理团队成员、邀请和权限，支持团队协作和权限控制。

```mermaid
classDiagram
class TeamMember {
+id : string
+name : string
+email : string
+avatar : string
+role : 'admin' | 'editor' | 'viewer'
+status : 'active' | 'inactive' | 'pending'
+lastActive : string
+joinedAt : string
+permissions : string[]
}
class TeamInvite {
+id : string
+email : string
+role : 'admin' | 'editor' | 'viewer'
+status : 'pending' | 'accepted' | 'expired' | 'cancelled'
+message : string
+createdAt : string
+expiresAt : string
+invitedBy : string
}
class Team {
+id : string
+name : string
+description : string
+ownerId : string
+createdAt : string
+settings : TeamSettings
}
class TeamSettings {
+allowInvites : boolean
+defaultRole : 'editor' | 'viewer'
+requireApproval : boolean
+maxMembers : number
}
class Permission {
+id : string
+name : string
+description : string
+category : string
}
useTeamStore --> Team : "管理"
useTeamStore --> TeamMember : "管理"
useTeamStore --> TeamInvite : "管理"
useTeamStore --> Permission : "管理"
Team --> TeamSettings : "配置"
```

**Diagram sources**
- [team.ts](file://packages/web-full/src/stores/team.ts#L15-L80)

### 自动化状态模块 (automation)
该模块管理测试套件、计划和执行结果，支持自动化测试和性能监控。

```mermaid
classDiagram
class TestSuite {
+id : string
+name : string
+description : string
+environment : string
+baseUrl : string
+status : 'active' | 'inactive'
+enabled : boolean
+tests : TestCase[]
+config : TestConfig
+notifications : NotificationConfig
+lastRun : number
+createdAt : number
+updatedAt : number
}
class TestCase {
+id : string
+name : string
+description : string
+method : HttpMethod
+url : string
+headers : Record~string, string~
+body : string
+assertions : Assertion[]
+enabled : boolean
+timeout : number
+order : number
}
class Assertion {
+id : string
+type : 'status' | 'body' | 'response_time'
+operator : 'equals' | 'not_equals' | 'less_than'
+expected : any
}
class TestConfig {
+timeout : number
+retryCount : number
+concurrency : number
+stopOnFailure : boolean
+generateReport : boolean
+enableScreenshot : boolean
+enableLogging : boolean
}
class NotificationConfig {
+email : EmailConfig
+webhook : WebhookConfig
+slack : SlackConfig
}
class TestResult {
+id : string
+testId : string
+testName : string
+suiteId : string
+status : 'passed' | 'failed'
+duration : number
+timestamp : number
+environment : string
+request : RequestConfig
+response : ResponseData
+assertions : AssertionResult[]
+error : string
+logs : LogEntry[]
}
class AssertionResult {
+id : string
+name : string
+passed : boolean
+expected : any
+actual : any
+message : string
}
class Schedule {
+id : string
+suiteId : string
+cron : string
+enabled : boolean
+lastRun : number
+nextRun : number
+createdAt : number
+updatedAt : number
}
useAutomationStore --> TestSuite : "管理"
useAutomationStore --> TestResult : "记录"
useAutomationStore --> Schedule : "管理"
TestSuite --> TestCase : "包含"
TestSuite --> TestConfig : "配置"
TestSuite --> NotificationConfig : "通知"
TestResult --> AssertionResult : "包含"
```

**Diagram sources**
- [automation.ts](file://packages/web-pro/src/stores/automation.ts#L15-L80)

## 模块化拆分原则与业务对应关系

状态模块的拆分遵循单一职责原则，每个模块对应特定的业务功能域：

- **collection模块**：对应API集合管理功能，负责API请求的组织、执行和历史记录
- **environment模块**：对应环境管理功能，负责环境变量、分组和模板的管理
- **workspace模块**：对应工作空间管理功能，是全局状态的协调中心
- **team模块**：对应团队协作功能，管理成员、权限和邀请
- **automation模块**：对应自动化测试功能，管理测试套件、计划和执行

这种模块化设计实现了关注点分离，降低了模块间的耦合度，提高了代码的可维护性和可测试性。

**Section sources**
- [collection.ts](file://packages/web-full/src/stores/collection.ts)
- [environment.ts](file://packages/web-full/src/stores/environment.ts)
- [workspace.ts](file://packages/web-full/src/stores/workspace.ts)
- [team.ts](file://packages/web-full/src/stores/team.ts)
- [automation.ts](file://packages/web-pro/src/stores/automation.ts)

## 异步操作处理模式

### API调用处理
所有异步操作都封装在actions中，采用统一的错误处理和用户反馈机制：

```mermaid
sequenceDiagram
participant 组件 as 组件
participant Store as Store
participant API as API
participant UI as UI反馈
组件->>Store : 调用action
Store->>Store : 设置loading状态
Store->>API : 执行异步操作
alt 成功
API-->>Store : 返回数据
Store->>Store : 更新状态
Store->>UI : 显示成功消息
Store->>Store : 保存到持久化存储
else 失败
API-->>Store : 返回错误
Store->>UI : 显示错误消息
Store->>Store : 记录错误日志
end
Store->>Store : 重置loading状态
Store-->>组件 : 返回结果
```

**Diagram sources**
- [collection.ts](file://packages/web-full/src/stores/collection.ts#L200-L300)
- [environment.ts](file://packages/web-full/src/stores/environment.ts#L200-L300)
- [workspace.ts](file://packages/web-full/src/stores/workspace.ts#L200-L300)

### 错误处理策略
- 使用try-catch捕获异步操作异常
- 统一使用ElMessage显示用户反馈
- 记录详细错误日志用于调试
- 提供有意义的错误信息

## 数据派生与getters使用

### 过滤与搜索
getters用于实现数据的动态过滤和搜索功能：

```mermaid
flowchart TD
A[原始数据] --> B{应用过滤条件}
B --> |搜索查询| C[按名称/描述/URL过滤]
B --> |方法筛选| D[按HTTP方法过滤]
B --> |标签筛选| E[按标签过滤]
B --> |分组筛选| F[按环境组过滤]
C --> G[返回过滤结果]
D --> G
E --> G
F --> G
G --> H[计算属性]
```

**Diagram sources**
- [collection.ts](file://packages/web-full/src/stores/collection.ts#L100-L150)
- [environment.ts](file://packages/web-full/src/stores/environment.ts#L100-L150)

### 统计与摘要
getters用于生成数据统计和摘要信息：

```mermaid
flowchart TD
A[原始数据] --> B[计算总数]
A --> C[计算成功数]
A --> D[计算失败数]
A --> E[计算平均时长]
B --> F[生成摘要对象]
C --> F
D --> F
E --> F
F --> G[返回统计结果]
```

**Diagram sources**
- [automation.ts](file://packages/web-pro/src/stores/automation.ts#L50-L100)

## 状态持久化机制

### 存储工具实现
使用统一的存储管理器实现状态持久化：

```mermaid
classDiagram
class StorageManager {
-prefix : string
+set~T~(key : string, value : T) : void
+get~T~(key : string, defaultValue? : T) : T | undefined
+remove(key : string) : void
+clear() : void
+getAllKeys() : string[]
}
StorageManager --> "localStorage" : "使用"
useCollectionStore --> StorageManager : "依赖"
useEnvironmentStore --> StorageManager : "依赖"
useWorkspaceStore --> StorageManager : "依赖"
```

**Diagram sources**
- [storage.ts](file://packages/shared/utils/storage.ts#L1-L55)

### 持久化策略
- 使用带前缀的键名避免命名冲突
- 自动序列化和反序列化JSON数据
- 提供默认值支持
- 支持批量清除相关数据

### 自动保存机制
通过watch监听状态变化，实现自动保存：

```mermaid
flowchart TD
A[状态变化] --> B{监听到变化}
B --> C[调用保存方法]
C --> D[序列化数据]
D --> E[存储到localStorage]
E --> F[处理存储错误]
```

**Section sources**
- [collection.ts](file://packages/web-full/src/stores/collection.ts#L700-L750)
- [environment.ts](file://packages/web-full/src/stores/environment.ts#L700-L750)
- [workspace.ts](file://packages/web-full/src/stores/workspace.ts#L700-L750)

## 状态调用链路示例

### 创建集合调用链路
展示从组件调用到状态更新的完整流程：

```mermaid
sequenceDiagram
participant 组件 as CollectionManagement.vue
participant Store as useCollectionStore
participant 持久化 as storage
participant 活动日志 as useWorkspaceStore
组件->>Store : createCollection(data)
Store->>Store : 设置loading状态
Store->>Store : 创建新集合对象
Store->>Store : 添加到collections数组
Store->>持久化 : saveCollections()
持久化->>持久化 : 序列化并存储
持久化-->>Store : 保存成功
Store->>活动日志 : logActivity()
活动日志->>活动日志 : 记录创建日志
活动日志-->>Store : 记录成功
Store->>组件 : 显示成功消息
Store->>Store : 重置loading状态
Store-->>组件 : 返回新集合
```

**Diagram sources**
- [collection.ts](file://packages/web-full/src/stores/collection.ts#L300-L350)

### 执行请求调用链路
展示API请求执行的完整流程：

```mermaid
sequenceDiagram
participant 组件 as RequestPanel.vue
participant Store as useCollectionStore
participant HTTP as HTTP请求
participant 持久化 as storage
组件->>Store : executeRequest(request)
Store->>Store : 设置testing状态
Store->>HTTP : 发送HTTP请求
HTTP-->>Store : 返回响应
Store->>Store : 创建历史记录
Store->>Store : 添加到requestHistory
Store->>持久化 : saveHistory()
持久化->>持久化 : 序列化并存储
持久化-->>Store : 保存成功
Store->>Store : 记录活动日志
Store->>组件 : 显示响应结果
Store->>Store : 重置testing状态
Store-->>组件 : 返回响应数据
```

**Diagram sources**
- [collection.ts](file://packages/web-full/src/stores/collection.ts#L500-L550)

## 依赖关系图

```mermaid
graph TD
A[组件] --> B[useCollectionStore]
A --> C[useEnvironmentStore]
A --> D[useWorkspaceStore]
A --> E[useTeamStore]
A --> F[useAutomationStore]
B --> G[storage]
C --> G
D --> G
E --> G
F --> G
D --> H[活动日志]
B --> D
C --> D
E --> D
F --> D
B --> I[请求执行]
F --> B
```

**Diagram sources**
- [collection.ts](file://packages/web-full/src/stores/collection.ts)
- [environment.ts](file://packages/web-full/src/stores/environment.ts)
- [workspace.ts](file://packages/web-full/src/stores/workspace.ts)
- [team.ts](file://packages/web-full/src/stores/team.ts)
- [automation.ts](file://packages/web-pro/src/stores/automation.ts)
- [storage.ts](file://packages/shared/utils/storage.ts)